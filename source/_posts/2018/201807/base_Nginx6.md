---
title: Nginx_基础 (6)
date: 2018-07-02
tags: Nginx
toc: true
---

### Nginx服务器如何处理请求
    先了解一下多进程方式、多线程方式、异步方式、同步方式、阻塞和非阻塞

<!-- more -->

#### 多进程方式
    服务器每当接收到一个客户端请求时,就由服务器主进程生成一个子进程出来和该客户端建立连接进行交互,直到连接断开,该子进程就结束了
- 优点
    * 设计和实现相对简单
    * 每个子进程之间相互独立,处理客户端请求的过程彼此不受到干扰,并且当一个子进程产生问题时,不容易将影响蔓延到其它进程
    * 当子进程退出时,其占用资源会被操作系统收回,也不会留下任何垃圾
- 缺点
    * 操作系统中生成一个子进程需要进行内存复制等操作,在资源和时间上回产生一定的额外开销,对系统资源造成压力,导致系统性能下降

#### 多线程方式
    每当服务器接收到一个客户端请求时,会由服务器主进程派生一个线程出来和该客户端进行交互
- 优点
    * 减轻了web服务器对系统资源的要求
    * 相对来说比较规范和有利于协作
- 缺点
    * 多个线程位于同一个进程内,可以访问同样的内存空间,彼此间互相影响
    * 开发过程中需要由开发者对内存进行管理,增加了出错风险,服务器系统需要长时间连续不停地运转,错误的积累可能会对整个服务器产生重大影响

#### 异步方式
- 发送方发出一个请求后,不等待接收方响应这个请求,就继续发送下个请求
- 所有来着发送方的请求形成一个队列,接收方处理完成后通知发送方

#### 同步方式
- 指发送方发送请求后,需要等待接收到接收方发回的响应后,才接着发送下一个请求
- 所有的请求在服务器端得到同步,发送方和接收方对请求的处理步调是一致的

#### 阻塞
- 调用结果返回之前,当前线程从运行状态被挂起,一直等到调用结果返回之后,才进行就绪状态,获取CPU后继续执行

#### 非阻塞
- 如果调用结果不能马上返回,当前线程也不会被挂起,而是立即返回执行下一个调用

#### 同步阻塞方式
    发送方向接收方发送请求后,一直等待响应；接收方处理请求是进行的IO操作如果不能马上得到结果,就一直等到返回结果后,才响应发送方,期间不能进行其他工作.
- eg
    * 在超时排队付账时,客户(发送方）想收款员(接收方）付款(发送请求）后需要等待收款员找零,期间不能做其他的事情；而收款员要等待收款机返回结果(IO操作）后才能把零钱取出来交给客户(响应请求）,期间也只能等待,不能做其他的事情.这种方式实现简单,但是效率不高.

#### 同步非阻塞方式
    发送方向接收方发送请求后,一直等待响应；接收方处理请求时进行的IO操作如果不能马上得到结果,就立即返回,去做其他事情,但由于没有得到请求处理结果,不响应发送方,发送方一直在等待,一直等IO操作完成后,接收方获得结果响应发送方后,接收方才进入下一次请求过程.在实际中不使用这种方式.

#### 异步阻塞方法
    发送方向接收方发送请求后,不用等待响应,可以继续其他工作；接收方处理请求是进行的IO操作如果不能马上得到结果,就一直等到返回结果后,才响应发送方,期间不能进行其他工作.这种方式在实际中也不使用.

#### 异步非阻塞方式
    发送方向接收方发送请求后,不用等待响应,可以继续其他工作；接收方处理请求时进行的IO操作富国不能马上得到结果,也不等待,而是马上返回去做其他事情.当IO操作完成以后,将完成状态和结果通知接收方,接收方再响应发送方.
- eg
    * 客户(发送方）想收款员(接收方）付款(发送请求）后在等待收款员找零的过程中,还可以做其他事情,比如打电话、聊天等；而收款员在等待收款机处理交易(IO操作）的过程中可以帮助客户将商品打包,当收款机产生结果后,收款员给客户结账(响应请求）.在四种方式中,这种方式是发送方和接收方通信效率最高的一种.
 
#### Nginx处理请求
    多进程异步非阻塞
    Nginx服务器启动后,可以产生一个主进程(master process)和多个工作进程(worker processes),其中可以在配置文件中指定产生的工作进程数量.Nginx服务器的所有工作进程都用于接收和处理客户端的请求.这类似于Apache使用的改进的多进程机制,预先生成多个工作进程,等待处理客户端请求.
    每个工作进程使用了异步非阻塞方式,可以处理多个客户端请.当某个工作进程接收到客户端的请求以后,调用IO进行处理,如果不能立即得到结果,就去处理其他的请求；儿客户端在此期间业务需等待响应,可以去处理其他的事情；当IO调用返回结果时,就会通知此工作进程；该进程的到通知,暂时挂起当前处理的事务,去响应客户端请求
- 主进程(master process)
    * 进行Nginx配置文件解析、数据结构初始化、模块配置和注册、信号处理、网络监听生成、工作进程生成和管理等工作
    * 读取Nginx配置文件并验证其有效性和正确性
    * 建立、绑定和关闭Socket
    * 按照配置生成、管理和结束工作进程
    * 接收外部指令,比如重启、升级及退出服务器等指令
    * 不中断服务,实现平滑重启,应用新配置
    * 不中断服务,实现平滑升级,升级失败进行回滚处理
    * 开启日志文件,获取文件描述符
    * 编译和处理Perl脚本
- 工作进程
    * 进行进程初始化、模块调用和请求处理等工作
    * 接收客户端请求
    * 将请求依次送入各个功能模块进行过滤处理
    * IO调用,获取响应数据
    * 与后端服务器通信,接收后端服务器处理结果
    * 数据缓存,访问缓存索引、查询和调用缓存数据
    * 发送请求结果,响应客户端请求
    * 接收主程序指令,比如重启、升级和退出等指令

