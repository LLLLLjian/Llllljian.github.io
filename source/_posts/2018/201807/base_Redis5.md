---
title: Redis_基础 (5)
date: 2018-07-21
tags: Redis
toc: true
---

### Redis多机数据库-复制
    在Redis中,用户可以通过执行SLAVEOF命令或者设置slaveof选项,让一个服务器去复制另一个服务器,我们称呼被复制的服务器为主服务器,而对主服务器进行复制的服务器被称为从服务器
    2.8之前称之为旧版复制
    2.8之后称之为新版复制

<!-- more -->

#### 旧版复制功能实现
- 同步
    * 同步操作作用于将从服务器的数据库状态更新至主服务器目前所处的数据库状态
    * 执行步骤
        * 从服务器向主服务器发送SYNC命令
        * 收到SYNC命令的主服务器执行BGSAVE命令,在后台生成一个RDB文件,并使用一个缓冲区记录从现在开始执行的所有写命令
        * 当主服务器的BGSAVE命令执行完毕时,主服务器会将BGSAVE生成的RDB文件发送给从服务器,从服务器接收并载入这个文件,将自己的数据库状态更新至主服务器执行BGSAVE命令时的数据库状态
        * 主服务器将记录在缓存区里面的所有写命令发送给从服务器,从服务器执行这些写命令,将自己的数据库状态更新至主服务器数据库当前所处状态
- 命令传播
    * 命令传播操作用于在主服务器的数据库状态被修改,导致主从服务器的数据库状态出现不一致时,让主从服务器的数据库重新回到一致状态
    * 每当主服务器执行客户端发送的写命令时,主服务器的数据库就有可能被修改并导致主从服务器状态不再一致,为了让主从服务器再次回到一致状态,主服务器会将自己执行的写命令发送给从服务器执行保证主从一致
- 缺陷
    * 当出现断线等意外操作的时候,不会将差异命令传播过去,而是会重新进行同步,再执行一次SYNC
    * 当每次需要执行SYNC命令,主从服务器需要执行以下动作
        * 主服务器需要执行BGSAVE命令来生成RDB文件,这个生成操作会耗费主服务器大量的CPU、内存和磁盘I/O资源
        * 主服务器需要将自己生成的RDB文件发送给从服务器,这个发送操作会耗费主从服务器大量的网络资源(带宽和流量),并对主服务器响应命令请求的时间产生影响
        * 接收到RDB文件的从服务器需要载入相应的文件,并且在载入期间,从服务器会因为阻塞没有办法处理命令请求

#### 新版复制功能实现

