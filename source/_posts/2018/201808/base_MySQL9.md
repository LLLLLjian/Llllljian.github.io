---
title: MySQL_基础 (9)
date: 2018-08-07
tags: MySQL
toc: true
---

### MySQL锁 
    锁: 数据库为了保证数据的一致性,而使各种共享资源在被并发访问变得有序所设计的一种规则
    SHOW PROCESSLIST

<!-- more -->

#### MyISAM表锁
    MyISAM存储引擎只支持表锁
    
    对MyISAM表的读操作，不会阻塞其他用户对同一表的读请求，但会阻塞对同一表的写请求
    对MyISAM表的写操作，则会阻塞其他用户对同一表的读和写操作
    MyISAM表的读操作与写操作之间，以及写操作之间是串行的
    当一个线程获得对一个表的写锁后，只有持有锁的线程可以对表进行更新操作.其他线程的读、写操作都会等待，直到锁被释放为止

    MyISAM在执行查询语句(SELECT)前，会自动给涉及的所有表加读锁
    在执行更新操作(UPDATE、DELETE、INSERT等)前，会自动给涉及的表加写锁
- 并发插入
    * 查看当前MyISAM表表中控制并发插入的系统变量
        ```sql
            mysql> show variables like '%concurrent_insert%';
            +-------------------+----------+
            |    Variable_name  |   Value  |
            +-------------------+----------+
            | concurrent_insert |    AUTO  |
            +-------------------+----------+
            1 row in set (0.00 sec)
        ```
    * value
        * 如果concurrent_insert设置为NEVER(or 0), 不允许并发插入
        * 变量是设置为AUTO(或者1),如果MyISAM表中没有空洞（即表的中间没有被删除的行），MyISAM允许在一个进程读表的同时，另一个进程从表尾插入记录
        * 如果该变量设置为ALWAYS (or 2), 无论MyISAM表中有没有空洞，都允许在表尾并发插入记录
- 锁调度
    * 默认认为写比读重要,所以一般是写进程先获得锁
    * 修改MyISAM 的调度行为
        * 通过指定启动参数low-priority-updates，使MyISAM引擎默认给予读请求以优先的权利
        * 通过执行命令SET LOW_PRIORITY_UPDATES=1，使该连接发出的更新请求优先级降低
        * 通过指定INSERT、UPDATE、DELETE语句的LOW_PRIORITY属性，降低该语句的优先级

#### InnoDB行锁
- 行锁
    * 共享锁
        * 允许一个事务去读一行，阻止其他事务获得相同的数据集的排他锁
        * 我读的时候，你可以读，但是不能写
    * 排他锁
        * 允许获得排他锁的事务更新数据，但是组织其他事务获得相同数据集的共享锁和排他锁
        * 我写的时候，你不能读也不能写.
- 表锁
    * 意向共享锁
        * 事务打算给数据行共享锁，事务在给一个数据行加共享锁前必须先取得该表的IS锁
    * 意向排他锁
        * 事务打算给数据行加排他锁，事务在给一个数据行加排他锁前必须先取得该表的IX锁
- 锁的实现
    * InnoDB行锁是通过给索引上的索引项加锁来实现的，只有通过索引条件检索数据，InnoDB才使用行级锁，否则，InnoDB将使用表锁
    