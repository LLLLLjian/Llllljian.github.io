---
title: MySQL_基础 (35)
date: 2020-01-10
tags: MySQL
toc: true
---

### 书写高质量SQL的30条建议
    优化SQL系列

<!-- more -->

#### 单表优化
- 字段
    * 尽量使用 TINYINT、 SMALLINT、 MEDIUM_INT 作为整数类型而非 INT, 如果非负则加上 UNSIGNED
    * VARCHAR 的长度只分配真正需要的空间
    * 使用枚举或整数代替字符串类型
    * 尽量使用 TIMESTAMP 而非 DATETIME
    * 单表不要有太多字段, 建议在 20 以内
    * 避免使用 NULL 字段, 很难查询优化且占用额外索引空间
    * 用整型来存 IP
- 索引
    * 索引并不是越多越好, 要根据查询有针对性的创建, 考虑在 WHERE 和 ORDER BY
    * 命令上涉及的列建立索引, 可根据 EXPLAIN 来查看是否用了索引还是全表扫描
    * 应尽量避免在 WHERE 子句中对字段进行 NULL 值判断, 否则将导致引擎放弃使用索引而进行全表扫描
    * 值分布很稀少的字段不适合建索引, 例如"性别"这种只有两三个值的字段
    * 字符字段只建前缀索引
    * 字符字段最好不要做主键
    * 不用外键, 由程序保证约束
    * 尽量不用 UNIQUE, 由程序保证约束
    * 使用多列索引时主意顺序和查询条件保持一致, 同时删除不必要的单列索引
- 查询SQL
    * 可通过开启慢查询日志来找出较慢的 SQL
    * 不做列运算: SELECT id WHERE age+1=10, 任何对列的操作都将导致表扫描, 它包括数据库教程函数、计算表达式等等, 查询时要尽可能将操作移至等号右边
    * sql 语句尽可能简单: 一条 sql 只能在一个 cpu 运算；大语句拆小语句, 减少锁时间；一条大sql 可以堵死整个库
    * 不用 SELECT *
    * OR 改写成 IN: OR 的效率是 n 级别,  IN 的效率是 log(n) 级别, IN 的个数建议控制在 200 以内
    * 不用函数和触发器, 在应用程序实现
    * 避免 %xxx 式查询
    * 少用 JOIN
    * 使用同类型进行比较, 比如用 '123' 和 '123' 比,  123 和 123 比
    * 尽量避免在 WHERE 子句中使用 != 或 <> 操作符, 否则将引擎放弃使用索引而进行全表扫描
    * 对于连续数值, 使用 BETWEEN 不用 IN: SELECT id FROM t WHERE num BETWEEN 1 AND 5
    * 列表数据不要拿全表, 要使用 LIMIT 来分页, 每页数量也不要太大

#### 引擎
- MyISAM
    * 不支持行锁, 读取时对需要读到的所有表加锁, 写入时则对表加排它锁
    * 不支持事务
    * 不支持外键
    * 不支持崩溃后的安全恢复
    * 在表有读取查询的同时, 支持往表中插入新纪录
    * 支持 BLOB 和 TEXT 的前 500 个字符索引, 支持全文索引
    * 支持延迟更新索引, 极大提升写入性能
    * 对于不会进行修改的表, 支持压缩表, 极大减少磁盘空间占用
- InnoDB
    * 支持行锁, 采用 MVCC 来支持高并发
    * 支持事务
    * 支持外键
    * 支持崩溃后的安全恢复
    * 不支持全文索引(5.6.4之后版本逐渐开始支持)
- 分库分表(水平分表、垂直分表)
    * 垂直分表: 
        * 垂直拆分是指数据表列的拆分,把一张列比较多的表拆分为多张表通常我们按以下原则进行垂直拆分:1. 把不常用的字段单独放在一张表;2. 把text,blob等大字段拆分出来放在附表中;3. 经常组合查询的列放在一张表中;
        * 垂直拆分更多时候就应该在数据表设计之初就执行的步骤,然后查询的时候用jion关键起来即可;
    * 水平分表: 
        * 水平拆分是指数据表行的拆分,表的行数超过200万行时,就会变慢,这时可以把一张表的数据拆成多张表来存放.通常情况下,我们使用取模的方式来进行表的拆分;比如一张有400W的用户表users,为提高其查询效率我们把其分成4张表users1,users2,users3,users4,通过用ID取模的方法把数据分散到四张表内
- 分区
    * mysql数据库中的数据是以文件的形势存在磁盘上的,默认放在/mysql/data下面(可以通过my.cnf中的datadir来查看),一张表主要对应着三个文件,一个是frm存放表结构的,一个是myd存放表数据的,一个是myi存表索引的.如果一张表的数据量太大的话,那么myd,myi就会变的很大,查找数据就会变的很慢,这个时候我们可以利用mysql的分区功能,在物理上将这一张表对应的三个文件,分割成许多个小块,这样呢,我们查找一条数据时,就不用全部查找了,只要知道这条数据在哪一块,然后在那一块找就行了.如果表的数据太大,可能一个磁盘放不下,这个时候,我们可以把数据分配到不同的磁盘里面去.mysql提供的分区属于横向分区,假如有100W条数据,分成十份,前10W条数据放到第一个分区,第二个10W条数据放到目前MySQL支持范围分区(RANGE),列表分区(LIST),哈希分区(HASH)以及KEY分区四种









