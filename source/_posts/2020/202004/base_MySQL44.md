---
title: MySQL_基础 (44)
date: 2020-04-10
tags: 
    - MySQL 
    - Interview
toc: true
---

### 更好的理解MySQL
    复制

<!-- more -->

#### 为什么需要复制
> MySQL内建的复制功能是构建大型,高性能应用程序的基础.随着目前并发量的增加,单机的MySQL渐渐没有办法承担这些请求,所以MySQL服务器也需要进行扩展.MySQL的复制功能不仅可以提高可用性,还能用作灾备,数据仓库等

#### 如何复制
1. SBR(statement-based replication)
    * 在这种模式下,bin log会完整的记录下所执行的SQL语句.也就是说,如果使用了statement格式的bin log的话,主库执行的SQL语句就会在从库中完整的再执行一遍.可是,这样的做法,是有可能导致主从不一致的.例如下面这样的语句：delete from t where a >= 1 and b => 2 limit 1;这样的语句在从库中就不一定能够实现跟主库一样的效果.因为我们不能够确定在从库中是否走的跟主库是同样的索引,所查找的第一条数据,是不是跟主库一样的,也就可能删除的数据不是同一行.又或者主库执行的SQL语句里面有一些锁相关的语句,也可能会造成主从不一致的问题.也就是说,基于statement模式,在上下文不同的时候,是有可能造成数据不一致的.
2. RBR(row-based replication)
    * 既然statement模式下会造成数据不一致,那么有没有一种模式是上下文无关的呢？所以就有了row模式.在这个模式中,bin log中只记录了所操作的行的修改情况,会精确到某一行.比如你更新了某一行,在bin log中就会记录在id等于多少多少,某某字段等于多少多少的行中,将某个字段的值从A改成了B.甚至是删除操作,都会记录删除了id等于多少,A字段等于多少,B字段等于多少的一行数据.听到这里你可能会觉得很方便,也很精确,主从不再会发生不一致的情况了.甚至于删库了都不需要跑路了,只需要查看bin log就能恢复相应的数据了.但是使用row模式同样会有一些问题.比如你在主库执行了delete from t where id < 10000这么一行sql语句,如果使statement格式,在bin log内记录只有这么一条,但是如果你使用的是row模式,那么就需要记录10000条数据,占用很大的空间.
3. MBR(mixd-based replication)
    * 于是就有了mixd模式.混合了以上两种模式的优点,MySQL会在没有歧义的时候使用statement格式,在有歧义的时候使用row格式

#### 复制的具体过程
![MySQL复制的具体过程](/img/20200410_1.png)
1. Binlog dump thread
    * 这个线程在MySQL主库中,负责读取bin log中的内容,并将这些内容推送到从库IO进程中.
2. I/O thread
    * 这个线程在MySQL从库中,负责跟主库建立一条长连接,并且将读取到的bin log数据保存到从库的中继日志(relay log)中.
3. SQL thread
    * 这个线程也是在MySQL的从库中,负责读取中继日志中的内容,然后执行这些语句,将对数据的修改应用到从库中

#### 出现主从复制延迟的原因
> Binlog dump thread执行完成的时间为t1, I/O thread执行完成的时间为t2, SQL thread执行完成的时间为t3, 延迟的时间为(t3-t1)
1. 网络问题
    * 网络确实可能会造成主从延迟,比如主库或者从库的带宽打满,又或者是主库的bin log被设置成了row格式,导致有大量的数据需要传输,造成了主库的bin log没有及时的同步到从库中,导致了主从的延迟.
2. 机器性能
    * 但是除了网络,更多的是从库的消费速度,跟不上主库的生产速度.这方面有很多原因,比如可能从库的机器配置低于主库,因为会有人觉得既然是备库,没什么请求,就把备库配置在了比较差的机器上面.又或者在是后台的数据分析,将CPU打满.总之,如果在从库中需要有大量的查询分析操作,需要考虑多个从库.
3. 大事务
    * 如果主库执行了一条耗时很长的事务,那么这条事务发送到从库中,可能也需要执行这么长的时间.而这个时候,从库是没有办法继续消费新的relay log的.这就造成了主从延迟.
4. 锁
    * 我们之前提到过了,不仅仅写数据会加锁,使用“当前读”,也一样可能会加锁.所以,如果在从库上执行了一些诸如select ... for update,或者一些DDL语句,可能也会造成从库加锁,导致主从延迟.
5. 并发
    * 在我们上面的介绍中,SQL线程是单线程的,所以,如果能够让SQL线程可以并发消费,那么主从延迟就可以大幅度的降低了.


