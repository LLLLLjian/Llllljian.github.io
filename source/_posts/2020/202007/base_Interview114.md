---
title: Interview_总结 (114)
date: 2020-07-14
tags: Interview
toc: true
---

### 面试题
    面试题汇总-API接口设计

<!-- more -->

#### token简介
- 是什么
    * 访问令牌access token, 用于接口中, 用于标识接口调用者的身份、凭证, 减少用户名和密码的传输次数.一般情况下客户端(接口调用方)需要先向服务器端申请一个接口调用的账号, 服务器会给出一个appId和一个key, key用于参数签名使用, 注意key保存到客户端, 需要做一些安全处理, 防止泄露.
- 取值
    * Token的值一般是UUID, 服务端生成Token后需要将token做为key, 将一些和token关联的信息作为value保存到缓存服务器中(redis), 当一个请求过来后, 服务器就去缓存服务器中查询这个Token是否存在, 存在则调用接口, 不存在返回接口错误, 一般通过拦截器或者过滤器来实现, Token分为两种: 
        * API Token(接口令牌): 用于访问不需要用户登录的接口, 如登录、注册、一些基本数据的获取等.获取接口令牌需要拿appId、timestamp和sign来换, sign=加密(timestamp+key)
        * USER Token(用户令牌): 用于访问需要用户登录之后的接口, 如: 获取我的基本信息、保存、修改、删除等操作.获取用户令牌需要拿用户名和密码来换

#### timestamp简介
> 每次调用接口时接口都会判断服务器当前系统时间和接口中传的的timestamp的差值, 如果这个差值超过某个设置的时间(假如5分钟), 那么这个请求将被拦截掉

#### sign 简介
- 是什么
    * 随机值, 是客户端随机生成的值, 作为参数传递过来, 随机值的目的是增加sign签名的多变性.随机值一般是数字和字母的组合, 6位长度, 随机值的组成和长度没有固定规则.
- 能做什么
    * 一般用于参数签名, 防止参数被非法篡改, 最常见的是修改金额等重要敏感参数,  sign的值一般是将所有非空参数按照升续排序然后+token+key+timestamp+nonce(随机数)拼接在一起, 然后使用某种加密算法进行加密, 作为接口中的一个参数sign来传递, 也可以将sign放到请求头中.接口在网络传输过程中如果被黑客挟持, 并修改其中的参数值, 然后再继续调用接口, 虽然参数的值被修改了, 但是因为黑客不知道sign是如何计算出来的, 不知道sign都有哪些值构成, 不知道以怎样的顺序拼接在一起的, 最重要的是不知道签名字符串中的key是什么, 所以黑客可以篡改参数的值, 但没法修改sign的值, 当服务器调用接口前会按照sign的规则重新计算出sign的值然后和接口传递的sign参数的值做比较, 如果相等表示参数值没有被篡改, 如果不等, 表示参数被非法篡改了, 就不执行接口了

#### 防止重复提交
> 对于一些重要的操作需要防止客户端重复提交的(如非幂等性重要操作), 具体办法是当请求第一次提交时将sign作为key保存到redis, 并设置超时时间, 超时时间和Timestamp中设置的差值相同.当同一个请求第二次访问时会先检测redis是否存在该sign, 如果存在则证明重复提交了, 接口就不再继续调用了.如果sign在缓存服务器中因过期时间到了, 而被删除了, 此时当这个url再次请求服务器时, 因token的过期时间和sign的过期时间一直, sign过期也意味着token过期, 那样同样的url再访问服务器会因token错误会被拦截掉, 这就是为什么sign和token的过期时间要保持一致的原因.拒绝重复调用机制确保URL被别人截获了也无法使用(如抓取数据)

#### 使用流程
1. 接口调用方(客户端)向接口提供方(服务器)申请接口调用账号, 申请成功后, 接口提供方会给接口调用方一个appId和一个key参数
2. 客户端携带参数appId、timestamp、sign去调用服务器端的API token, 其中sign=加密(appId + timestamp + key)
3. 客户端拿着api_token 去访问不需要登录就能访问的接口
4. 当访问用户需要登录的接口时, 客户端跳转到登录页面, 通过用户名和密码调用登录接口, 登录接口会返回一个usertoken, 客户端拿着usertoken 去访问需要登录才能访问的接口

