---
title: 杂项_总结 (04)
date: 2021-01-05
tags: Others
toc: true
---

### 工作踩坑
    SSO单点登陆

<!-- more -->

#### 名词解释
- Single Sign On
    * 简称: SSO
    * 在多系统应用群中登录一个系统,便可在其他所有系统中得到授权而无需再次登录,包括单点登录与单点注销两部分
- 全局会话
    * 用户登录成功之后,会与sso认证中心及各个子系统建立会话,用户与sso认证中心建立的会话
- 局部会话
    * 用户与各个子系统建立的会话
- Central Authentication Service
    * 简称: CAS
    * 集中式认证服务,是一种针对互联网的单点登录协议
    * 它的目的是允许一个用户访问多个应用程序,而只需提供一次凭证(如用户名和密码).它还允许web应用程序在没有获得用户的安全凭据(如密码)的情况下对用户进行身份验证,从总体架构上来看CAS包含服务端和客户端两个独立的组件,他们之间通过各种协议进行通信

#### 单点登陆
> 相比于单系统登录,sso需要一个独立的认证中心,只有认证中心能接受用户的用户名密码等安全信息,其他系统不提供登录入口,只接受认证中心的间接授权.间接授权通过令牌实现,sso认证中心验证用户的用户名密码没问题,创建授权令牌,在接下来的跳转过程中,授权令牌作为参数发送给各个子系统,子系统拿到令牌,即得到了授权,可以借此创建局部会话,局部会话登录方式与单系统的登录方式相同
- 流程图
    * ![单点登录流程图](/img/20210105_1.png)
- 流程图简要描述
    * 用户访问系统1的受保护资源,系统1发现用户未登录,跳转至sso认证中心,并将自己的地址作为参数
    * sso认证中心发现用户未登录,将用户引导至登录页面
    * 用户输入用户名密码提交登录申请
    * sso认证中心校验用户信息,创建用户与sso认证中心之间的会话,称为全局会话,同时创建授权令牌
    * sso认证中心带着令牌跳转会最初的请求地址(系统1)
    * 系统1拿到令牌,去sso认证中心校验令牌是否有效
    * sso认证中心校验令牌,返回有效,注册系统1
    * 系统1使用该令牌创建与用户的会话,称为局部会话,返回受保护资源
    * 用户访问系统2的受保护资源
    * 系统2发现用户未登录,跳转至sso认证中心,并将自己的地址作为参数
    * sso认证中心发现用户已登录,跳转回系统2的地址,并附上令牌
    * 系统2拿到令牌,去sso认证中心校验令牌是否有效
    * sso认证中心校验令牌,返回有效,注册系统2
    * 系统2使用该令牌创建与用户的局部会话,返回受保护资源

#### 全局会话与局部会话的约束关系
1. 局部会话存在,全局会话一定存在
2. 全局会话存在,局部会话不一定存在
3. 全局会话销毁,局部会话必须销毁

#### 单点注销
> 单点登录自然也要单点注销,在一个子系统中注销,所有子系统的会话都将被销毁
- 流程图
    * ![单点注销流程图](/img/20210105_2.png)
- 流程图简要描述
    * 用户向系统1发起注销请求
    * 系统1根据用户与系统1建立的会话id拿到令牌,向sso认证中心发起注销请求
    * sso认证中心校验令牌有效,销毁全局会话,同时取出所有用此令牌注册的系统地址
    * sso认证中心向所有注册系统发起注销请求
    * 各注册系统接收sso认证中心的注销请求,销毁局部会话
    * sso认证中心引导用户至登录页面

#### CAS图解
- 流程图
    * ![CAS](/img/20210105_3.png)
- 举个栗子
    * 故事前景: 现在有两个系统,分别是系统A llllljian1.com和系统B llllljian2.com,一个SSO sso.com
    1. 用户A想访问 llllljian1.com中需要登陆的某些页面
    2. 系统A发现用户还没有登陆
    3. 重定向到sso认证中心,并将自己的地址作为参数.请求的地址如下: sso.com?service=llllljian1.com
    4. sso认证中心发现用户未登录,将用户引导至登录页面,用户进行输入用户名和密码进行登录,用户与认证中心建立全局会话(生成一份Token,写到Cookie中,保存在浏览器上)
    5. 认证中心重定向回系统A,并把Token携带过去给系统A,重定向的地址如下: llllljian1.com?token=xxxxxxx
    6. 系统A去sso认证中心验证这个Token是否正确,如果正确,则系统A和用户建立局部会话(创建Session).到此,系统A和用户已经是登录状态了
    7. 用户想要访问系统B llllljian2.com受限的资源(比如说订单功能,订单功能需要登录后才能访问)
    8. 系统B llllljian2.com发现用户并没有登录
    9. 于是重定向到sso认证中心,并将自己的地址作为参数.请求的地址如下: sso.com?service=llllljian2.com
    10. 注意,因为之前用户与认证中心sso.com已经建立了全局会话(当时已经把Cookie保存到浏览器上了),所以这次系统B重定向到认证中心sso.com是可以带上Cookie的
    11. 认证中心根据带过来的Cookie发现已经与用户建立了全局会话了,认证中心重定向回系统B,并把Token携带过去给系统B,重定向的地址如下: llllljian2.com?token=xxxxxxx
    12. 系统B去sso认证中心验证这个Token是否正确,如果正确,则系统B和用户建立局部会话(创建Session).到此,系统B和用户已经是登录状态了
