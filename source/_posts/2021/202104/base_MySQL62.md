---
title: MySQL_基础 (62)
date: 2021-04-26
tags: MySQL
toc: true
---

### 更好的理解MySQL
    我对like "aaa%" 和 like "%aaa%"的理解还是不够

<!-- more -->

#### 故事背景
> 之前说到索引是否失效的问题, 我就试着去建了张表, 然后问题就来了

#### like到底什么情况下不用索引
- eg1
    ```sql
        mysql> show create table test_name;
        +-----------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
        | Table     | Create Table                                                                                                                                                                                                                     |
        +-----------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
        | test_name | CREATE TABLE `test_name` (
        `id` int(11) NOT NULL AUTO_INCREMENT,
        `name` varchar(30) NOT NULL,
        `age` tinyint(2) NOT NULL,
        PRIMARY KEY (`id`),
        KEY `name` (`name`)
        ) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8 |
        +-----------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
        1 row in set (0.01 sec)

        mysql> select * from test_name where name like "llllljian%";
        +----+--------------+-----+
        | id | name         | age |
        +----+--------------+-----+
        |  5 | llllljian123 |   0 |
        |  6 | llllljian456 |   0 |
        +----+--------------+-----+
        2 rows in set (0.01 sec)

        mysql> explain select * from test_name where name like "llllljian%";
        +----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+
        | id | select_type | table     | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                 |
        +----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+
        |  1 | SIMPLE      | test_name | NULL       | range | name          | name | 92      | NULL |    2 |   100.00 | Using index condition |
        +----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+
        1 row in set, 1 warning (0.00 sec)

        mysql> explain select * from test_name where name like "%llllljian";
        +----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------------+
        | id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
        +----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------------+
        |  1 | SIMPLE      | test_name | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    6 |    16.67 | Using where |
        +----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------------+
        1 row in set, 1 warning (0.00 sec)

        mysql> explain select * from test_name where name like "%llllljian%";
        +----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------------+
        | id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
        +----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------------+
        |  1 | SIMPLE      | test_name | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    6 |    16.67 | Using where |
        +----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------------+
        1 row in set, 1 warning (0.00 sec)

        mysql> show create table test_name1;
        +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
        | Table      | Create Table                                                                                                                                                                                                                      |
        +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
        | test_name1 | CREATE TABLE `test_name1` (
        `id` int(11) NOT NULL AUTO_INCREMENT,
        `name` varchar(30) NOT NULL,
        `age` tinyint(2) NOT NULL,
        PRIMARY KEY (`id`),
        KEY `name` (`name`)
        ) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8 |
        +------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
        1 row in set (0.00 sec)

        mysql> select * from test_name1 where name like "llllljian%";
        +----+------------+-----+
        | id | name       | age |
        +----+------------+-----+
        |  1 | llllljian  |   0 |
        |  2 | llllljian1 |   0 |
        |  3 | llllljian2 |   0 |
        |  4 | llllljian3 |   0 |
        |  5 | llllljian4 |   0 |
        +----+------------+-----+
        5 rows in set (0.00 sec)

        mysql> explain select * from test_name1 where name like "llllljian%";
        +----+-------------+------------+------------+------+---------------+------+---------+------+------+----------+-------------+
        | id | select_type | table      | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
        +----+-------------+------------+------------+------+---------------+------+---------+------+------+----------+-------------+
        |  1 | SIMPLE      | test_name1 | NULL       | ALL  | name          | NULL | NULL    | NULL |    5 |   100.00 | Using where |
        +----+-------------+------------+------------+------+---------------+------+---------+------+------+----------+-------------+
        1 row in set, 1 warning (0.00 sec)

        mysql> explain select * from test_name1 where name like "%llllljian";
        +----+-------------+------------+------------+------+---------------+------+---------+------+------+----------+-------------+
        | id | select_type | table      | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
        +----+-------------+------------+------------+------+---------------+------+---------+------+------+----------+-------------+
        |  1 | SIMPLE      | test_name1 | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    5 |    20.00 | Using where |
        +----+-------------+------------+------------+------+---------------+------+---------+------+------+----------+-------------+
        1 row in set, 1 warning (0.00 sec)

        mysql> explain select * from test_name1 where name like "%llllljian%";
        +----+-------------+------------+------------+------+---------------+------+---------+------+------+----------+-------------+
        | id | select_type | table      | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
        +----+-------------+------------+------------+------+---------------+------+---------+------+------+----------+-------------+
        |  1 | SIMPLE      | test_name1 | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    5 |    20.00 | Using where |
        +----+-------------+------------+------------+------+---------------+------+---------+------+------+----------+-------------+
        1 row in set, 1 warning (0.00 sec)
    ```
- 结论1
    * 正常情况下, like "aaa%"会用到索引, like "%aaa%"和like "%aaa"不会用到索引
    * 数据异常的情况下, like "aaa%"、like "%aaa%"、like "%aaa"都不会用到索引
- eg2
    ```sql
        mysql> explain select name from test_name where name like "llllljian%";
        +----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        | id | select_type | table     | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                    |
        +----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        |  1 | SIMPLE      | test_name | NULL       | range | name          | name | 92      | NULL |    2 |   100.00 | Using where; Using index |
        +----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        1 row in set, 1 warning (0.00 sec)

        mysql>
        mysql> explain select name from test_name where name like "%llllljian%";
        +----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        | id | select_type | table     | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                    |
        +----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        |  1 | SIMPLE      | test_name | NULL       | index | NULL          | name | 92      | NULL |    6 |    16.67 | Using where; Using index |
        +----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        1 row in set, 1 warning (0.00 sec)

        mysql> explain select name from test_name where name like "%llllljian";
        +----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        | id | select_type | table     | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                    |
        +----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        |  1 | SIMPLE      | test_name | NULL       | index | NULL          | name | 92      | NULL |    6 |    16.67 | Using where; Using index |
        +----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        1 row in set, 1 warning (0.00 sec)

        mysql> explain select name from test_name1 where name like "llllljian%";
        +----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        | id | select_type | table      | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                    |
        +----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        |  1 | SIMPLE      | test_name1 | NULL       | index | name          | name | 92      | NULL |    5 |   100.00 | Using where; Using index |
        +----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        1 row in set, 1 warning (0.00 sec)

        mysql> explain select name from test_name1 where name like "%llllljian%";
        +----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        | id | select_type | table      | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                    |
        +----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        |  1 | SIMPLE      | test_name1 | NULL       | index | NULL          | name | 92      | NULL |    5 |    20.00 | Using where; Using index |
        +----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        1 row in set, 1 warning (0.00 sec)

        mysql> explain select name from test_name1 where name like "%llllljian";
        +----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        | id | select_type | table      | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                    |
        +----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        |  1 | SIMPLE      | test_name1 | NULL       | index | NULL          | name | 92      | NULL |    5 |    20.00 | Using where; Using index |
        +----+-------------+------------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
        1 row in set, 1 warning (0.01 sec)
    ```
- 结论2
    * 如果去掉select *, 而是改为select name, 就会使用到覆盖索引, 不管like之后的百分号在哪都可以用到索引, 但是就算用到索引, 效率还是有差别的, 可以通过explain中的rows大致看到查询结果需要扫描的行数, 除了explain select * from test_name where name like "llllljian%";explain select name from test_name where name like "llllljian%";type一直是range, 并且rows一直是2之外, 其余的所有语句不管type是index还是all, 所扫描的行数都是全表了
- 结论
    * 给自己敲了个警钟吧, 首先不要一直信别人的结论, 自己也要多试试, 其次要整个理解mysql的查询, 半知半解问题很大

