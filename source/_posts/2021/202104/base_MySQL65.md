---
title: MySQL_基础 (65)
date: 2021-04-29
tags: MySQL
toc: true
---

### 更好的理解MySQL
    MySQL实战45讲

<!-- more -->

#### 故事背景
> 今天在b站学习mysql的时候 突然觉得b站的学习氛围不是很好了呀, 都是随便讲的, 都是想吃互联网第二波饭的人, 两个小时的视频里有一个多小时是在卖课,  在给人洗脑, 然后我就找呀找, 最后找到了【MySQL实战45讲】, 看过的人都说好, 我也来看看吧, 学一学

#### 03事务隔离: 为什么你改了我还看不见
事务就是要保证一组数据库操作要么全部成功, 要么全部失败.
事务支持是在引擎层实现的, 但并不是所有引擎都支持事务, MyISAM引擎就不支持事务.
多事务同时执行的时候, 可能会出现的问题: 脏读、不可重复读、幻读.
- SQL标准的事务隔离级别
    * 读未提交.是指一个事务还没提交时, 它做的变更就能够被其他事务看到.
    * 读提交.是指一个事务提交之后, 它做的变更才会被其他事务看到.
    * 可重复读.是指一个事务在执行过程中看到的数据, 总是跟这个事务启动时看到的数据是一致的.
    * 串行化.串行化, 顾名思义是对于同一行记录, “写”会加“写锁”, “读”会加“读锁”.当出现读写锁冲突时, 后访问的事务必须等待前一个事务执行完成, 才能继续执行.
- MySQL事务启动方式
    * 显式启动事务语句,  begin 或 start transaction.提交语句commit, 回滚语句rollback.
    * set autocommit=0, 这个命令会将这个线程的自动提交关闭.

#### 04深入浅出索引(上)

索引的出现是为了提高数据库查询效率, 就像书的目录一样.

常见的索引模型: 

- 哈希表
- 有序数组
- 搜索树

哈希表这种结构适用于只有等值查询的场景, 比如 Memcached及其他一些nosql引擎.由于哈希表存储不是有序的, 因此做区间查询的速度是很慢的.

而有序数组在等值查询和范围查询场景中的性能就都非常优秀.有序数组只适用于静态存储引擎, 由于它是有序存储, 因此在插入数据时, 要挪动后面的所有数据, 成本太高.

为了让一个查询尽量少地读磁盘, 就必须让查询过程访问尽量少的数据块.因此使用N叉数, 而不是二叉树.


##### InnoDB 的索引模型

在 InnoDB 中, 表都是根据主键顺序以索引的形式存放的, 这种存储方式的表称为索引组织表.InnoDB使用的是B+树索引模型.

每一个索引在 InnoDB 里面对应一棵 B+ 树.B+树能够很好地配合磁盘的读写特性, 减少单词查询时访问磁盘的次数.

主键索引的叶子节点存的是整行数据.在 InnoDB 里, 主键索引也被称为聚簇索引.

非主键索引的叶子节点内容是主键的值.在 InnoDB 里, 非主键索引也被称为二级索引.

普通索引的查询方式是先搜索普通索引树, 找到主键值, 再去搜索主键索引树.这个过程也被称为回表.也就是说, 基于非主键索引的查询需要多扫描一棵索引树.因此, 我们在应用中应尽量使用主键查询.

数据页的分裂与合并: 当数据页已满时, 有新的数据插入就会申请新的数据页, 并把部分数据移动过去, 这个过程称为数据页的分裂, 不仅性能会受影响, 而且数据页的利用率也会降低.当相邻的两个数据页由于数据删除, 导致利用率很低时, 就会将数据页合并.

从性能和存储空间方面考量, 自增主键往往是更合理的选择.

#### 05深入浅出索引(下)

有普通索引查询主键值, 再回到主键索引树搜索的过程称为回表.那如何优化索引避免回表呢: 

**覆盖索引**.指的是普通索引树上, 节点已经包含了要查询的信息, 也就是普通索引“覆盖了”我们的查询需求, 因此就不用再使用主键查询, 避免了回表.由于覆盖索引可以减少树的搜索次数, 显著提升查询性能, 所以使用覆盖索引是一个常用的优化手段.

**最左前缀原则**.B+ 树这种索引结构, 可以利用索引的“最左前缀”, 来定位记录.不只是索引的全部定义, 只要满足最左前缀, 就可以利用索引来加速检索.最左前缀可以是联合索引的最左N个字段, 也可以是字符串索引的最左M个字符.

联合索引如何安排字段顺序: 

- 如果可以通过改变字段顺序, 从而少维护一个索引, 那么将是优先考虑的
- 第二个考虑原则是空间

##### 索引下推

而 MySQL 5.6 引入的索引下推优化, 在索引遍历过程中, 对索引包含的字段先做判断, 直接过滤掉不满足条件的记录, 减少回表次数.
