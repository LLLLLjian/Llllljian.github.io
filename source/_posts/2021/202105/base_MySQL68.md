---
title: MySQL_基础 (68)
date: 2021-05-07
tags: MySQL
toc: true
---

### 更好的理解MySQL
    MySQL实战45讲

<!-- more -->

#### 故事背景
> 今天在b站学习mysql的时候 突然觉得b站的学习氛围不是很好了呀, 都是随便讲的, 都是想吃互联网第二波饭的人, 两个小时的视频里有一个多小时是在卖课,  在给人洗脑, 然后我就找呀找, 最后找到了【MySQL实战45讲】, 看过的人都说好, 我也来看看吧, 学一学

#### 09普通索引和唯一索引, 应该怎么选择？

**change buffer：**
    
当需要更新一个数据页时,如果数据页在内存中就直接更新,而如果这个数据页还没有在内存中的话,在不影响数据一致性的前提下,InooDB 会将这些更新操作缓存在 change buffer中, 这样就不需要从磁盘中读入这个数据页了.在下次查询需要访问这个数据页的时候,将数据页读入内存中, 然后执行 change buffer 中与这个页有关的操作.通过这种方式就能保证这个数据逻辑的正确性.

唯一索引要确定其唯一性, 因此必须要将数据页读取到内存中, 判断其是否唯一.所以唯一索引用不到change buffer, 普通索引可以用到.

change buffer 使用的是buffer pool里的内存, change buffer实际上是可以持久化的数据, 将 change buffer 中的操作应用到原数据页,得到最新结果的过程称为 merge.系统后台会定期merge, 数据库正常关闭也会merge.

##### change buffer 的使用场景

对于读多写少的业务来说, 页面在写完之后马上读的概率很小, 因此很多更新操作会缓存之change buffer 中, 这样的话使用效果会很好.但是业务是写入之后会马上读取的话, 会触发merge, 这样随机访问IO的次数不会减少, 同时又增加了change buffer的维护成本, 这样反而起到了副作用.

##### 索引选择和实践

普通索引和唯一索引应该怎么选择,其实,这两类索引在查询能力上是没差别的,主要考虑的是对更新性能的影响.所以,我建议你尽量选择普通索引.

##### change buffer 和 redo log

redo log 主要节省的是随机写磁盘的 IO 消耗(转成顺序写),而 change buffer 主要节省的则是随机读磁盘的 IO 消耗.

#### 10MySQL为什么有时候会选错索引？

使用哪个索引是由 MySQL 来确定的, 确切的说是优化器的工作.


##### 优化器的逻辑

查询扫描行数是优化器重要的依据条件之一.

一个索引上不同的值越多, 这个索引的区分度就越好.索引上不同值的个数也称为基数.基数是通过采样统计来得出的值, 采样统计时, InnoDB默认会选择N个数据页, 统计这些页面上的不同值, 得到一个平均值, 然后乘以这个索引的页面数, 就得到了这个索引的基数.

analyze table t 命令, 可以用来重新统计索引信息.在实践中, 如果发现explain的结果预估的rows值跟实际情况差距比较大, 可以使用这个方法处理.


##### 索引选择异常和处理

大多数时候优化器都能找到正确的索引, 但偶尔会选错索引.这是有以下处理方法：

1. 采用force index强行选择一个索引.缺点：变更的及时性.线上系统修改SQL语句还要测试、发布等, 不够敏捷.
2. 修改语句, 引导MySQL使用我们期望的索引.例如：在逻辑结果一致时可以把：order by b limit 1 改为 order by b,a limit 1(注意文章的上下文).缺点：根据数据特征诱导了一下优化器, 不具备通用性.
3. 在有些场景下, 我们可以新建一个更合适的索引, 来提供给优化器做选择, 或删掉误用的索引.缺点是找到更合适的索引比较难.如果误用的索引没必要存在, 可以删除.

