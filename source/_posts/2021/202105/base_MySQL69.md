---
title: MySQL_基础 (69)
date: 2021-05-08
tags: MySQL
toc: true
---

### 更好的理解MySQL
    MySQL实战45讲

<!-- more -->

#### 故事背景
> 今天在b站学习mysql的时候 突然觉得b站的学习氛围不是很好了呀, 都是随便讲的, 都是想吃互联网第二波饭的人, 两个小时的视频里有一个多小时是在卖课,  在给人洗脑, 然后我就找呀找, 最后找到了【MySQL实战45讲】, 看过的人都说好, 我也来看看吧, 学一学

#### 11怎么给字符串字段加索引

MySQL支持前缀索引, 你可以定义字符串的一部分作为索引.默认地, 创建时不指定长度索引就会包含整个字符串.

前缀索引只取字符串前几位, 比整个字符串索引占用空间更小.但可能会增加额外的记录扫描次数, 因为依据前缀查询后, 要去主键索引查找判断是否正确, 这时有可能前缀一样后面的字符串不一致, 就需要再去字符串索引查找, 这就增加了记录扫描次数(回主键查找次数).

使用前缀索引, 定义好长度, 就可以做到既节省空间, 又不用额外增加太多的查询成本.

如何确定前缀的长度：
1、统计出这个列上有多少个不同的值：

    mysql> select count(distinct email) as L from SUser;

2、依次取不同长度的前缀来统计不同值, 看哪个值不小于 L * 95%(5%接受区分度损失比例)：

    mysql> select
      count(distinct left(email,4))as L4,
      count(distinct left(email,5))as L5,
      count(distinct left(email,6))as L6,
      count(distinct left(email,7))as L7,
    from SUser;


##### 前缀索引对覆盖索引的影响

使用前缀索引就用不上覆盖索引对查询性能的优化了.例如在不使用前缀索引情况下, 覆盖索引含有要查询的信息, 就不用回表查询ID索引了.使用了前缀索引, 还需查询ID索引确认是否是要查找的记录.


##### 其他方式

如果遇到前缀的区分度不够好的情况时, 该怎么办：

1. 第一种方式是使用倒序存储.有时字符串倒叙会有很好的区分度.

    mysql> select field_list from t where id_card = reverse('input_id_card_string');

2. 第二种方式是使用hash字段.你可以在表上再创建一个整数字段, 来保存身份证的校验码, 同时在这个字段上创建索引.

    mysql> alter table t add id_card_crc int unsigned, add index(id_card_crc);


    mysql> select field_list from t where id_card_crc=crc32('input_id_card_string') and id_card='input_id_card_string'


##### 异同点

相同点：都不支持范围查询.倒叙存储是按照倒叙字符串排序的, hash字段只能支持等值查询.

区别：

1. 从占用额外空间来看, 倒叙存储方式在主键索引上, 不会消耗额外的存储空间, 而hash需要增加一个字段.当然倒叙存储方式使用4个字节的前缀长度应该是不够的, 再长一点, 消耗和hash也差不多.
2. 在CPU消耗方面, 倒叙需要调用reverse函数, hash需要调用crc32()函数.reverse函数的额外消耗CPU资源会更小些.
3. 从查询效率上看, 使用hash字段方式的查询性能相对更稳定一些.hash每次查询平均扫描次数接近1.倒叙使用前缀索引, 会增加回表查询次数.


##### 总结：

1. 直接创建完整索引,这样可能比较占用空间;
2. 创建前缀索引,节省空间,但会增加查询扫描次数,并且不能使用覆盖索引;
3. 倒序存储,再创建前缀索引,用于绕过字符串本身前缀的区分度不够的问题；
4. 创建 hash 字段索引,查询性能稳定,有额外的存储和计算消耗,跟第三种方式一样,都不支持范围扫描.