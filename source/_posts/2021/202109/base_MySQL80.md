---
title: MySQL_基础 (80)
date: 2021-09-15
tags: MySQL
toc: true
---

### 更好的理解MySQL
    Mysql主从复制和读写分离

<!-- more -->

#### 主从复制
- 什么是主从复制
    * 主从复制, 是用来建立一个和主数据库完全一样的数据库环境, 称为从数据库；主数据库一般是准实时的业务数据库
- 主从复制的作用
    * 做数据的热备, 作为后备数据库, 主数据库服务器故障后, 可切换到从数据库继续工作, 避免数据丢失
    * 架构的扩展.业务量越来越大, I/O访问频率过高, 单机无法满足, 此时做多库的存储, 降低磁盘I/O访问的频率, 提高单个机器的I/O性能
    * 读写分离, 使数据库能支撑更大的并发.在报表中尤其重要.由于部分报表sql语句非常的慢, 导致锁表, 影响前台服务.如果前台使用master, 报表使用slave, 那么报表sql将不会造成前台锁, 保证了前台速度
- 主从复制的原理
    * 客户端SQL更新命令
    * 主库执行
    * 主库写binlog
    * 主库client线程读binlog发送给从库的io线程
    * 从库io线程写盘(relay-log)
    * 从库sql线程读relay-log
    * 执行更新
    * 主要涉及三个线程: binlog 线程、I/O 线程和 SQL 线程.
        * binlog 线程 : 负责将主服务器上的数据更改写入二进制日志(Binary log)中
        * I/O 线程 : 负责从主服务器上读取二进制日志, 并写入从服务器的重放日志(Replay log)中
        * SQL 线程 : 负责读取重放日志并重放其中的SQL语句

#### 出现主从复制延迟的原因
> Binlog dump thread执行完成的时间为t1, I/O thread执行完成的时间为t2, SQL thread执行完成的时间为t3, 延迟的时间为(t3-t1)
1. 网络问题
    * 网络确实可能会造成主从延迟,比如主库或者从库的带宽打满,又或者是主库的bin log被设置成了row格式,导致有大量的数据需要传输,造成了主库的bin log没有及时的同步到从库中,导致了主从的延迟.
2. 机器性能
    * 但是除了网络,更多的是从库的消费速度,跟不上主库的生产速度.这方面有很多原因,比如可能从库的机器配置低于主库,因为会有人觉得既然是备库,没什么请求,就把备库配置在了比较差的机器上面.又或者在是后台的数据分析,将CPU打满.总之,如果在从库中需要有大量的查询分析操作,需要考虑多个从库.
3. 大事务
    * 如果主库执行了一条耗时很长的事务,那么这条事务发送到从库中,可能也需要执行这么长的时间.而这个时候,从库是没有办法继续消费新的relay log的.这就造成了主从延迟.
4. 锁
    * 我们之前提到过了,不仅仅写数据会加锁,使用“当前读”,也一样可能会加锁.所以,如果在从库上执行了一些诸如select ... for update,或者一些DDL语句,可能也会造成从库加锁,导致主从延迟.
5. 并发
    * 在我们上面的介绍中,SQL线程是单线程的,所以,如果能够让SQL线程可以并发消费,那么主从延迟就可以大幅度的降低了.


#### 读写分离
- 什么是读写分离
    * 其实就是将数据库分为了主从库, 一个主库用于写数据, 多个从库完成读数据的操作, 主从库之间通过某种机制进行数据的同步, 是一种常见的数据库架构.
- 数据库分组架构解决什么问题
    * 大多数互联网业务, 往往读多写少, 这时候, 数据库的读会首先称为数据库的瓶颈, 这时, 如果我们希望能够线性的提升数据库的读性能, 消除读写锁冲突从而提升数据库的写性能, 那么就可以使用“分组架构”(读写分离架构).用一句话概括, 读写分离是用来解决数据库的读性能瓶颈的
- mysql读写分离原理
    * 读写分离就是在主服务器上修改, 数据会同步到从服务器, 从服务器只能提供读取数据, 不能写入, 实现备份的同时也实现了数据库性能的优化, 以及提升了服务器安全.读写分离常用代理方式来实现, 代理服务器接收应用层传来的读写请求, 然后决定转发到哪个服务器
- 常见的Mysql读写分离
    * 基于程序代码内部实现: 在代码中根据select 、insert进行路由分类, 这类方法也是目前生产环境下应用最广泛的.优点是性能较好, 因为程序在代码中实现, 不需要增加额外的硬件开支, 缺点是需要开发人员来实现, 运维人员无从下手.
    * 基于中间代理层实现: mysql_proxy是Mysql的一个开源项目, 通过其自带的lua脚本进行sql判断
- 读写分离能提高性能的原因
    * 主从服务器负责各自的读和写, 极大程度缓解了锁的争用
    * 从服务器可以使用 MyISAM, 提升查询性能以及节约系统开销
    * 增加冗余, 提高可用性







