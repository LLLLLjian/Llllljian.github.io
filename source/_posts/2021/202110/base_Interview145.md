---
title: Interview_总结 (145)
date: 2021-10-25
tags: Interview
toc: true
---

### 面试题
    别看了 这就是你的题

<!-- more -->

#### nginx是如何实现高并发的
> 异步, 非阻塞, 使用了epoll 和大量的底层代码优化

nginx采用一个master进程, 多个woker进程的模式

1. master进程主要负责收集、分发请求. 每当一个请求过来时, master就拉起一个worker进程负责处理这个请求. 
2. 同时master进程也负责监控woker的状态, 保证高可靠性
3. woker进程一般设置为跟cpu核心数一致. nginx的woker进程在同一时间可以处理的请求数只受内存限制, 可以处理多个请求. 
4. Nginx 的异步非阻塞工作方式正把当中的等待时间利用起来了. 在需要等待的时候, 这些进程就空闲出来待命了, 因此表现为少数几个进程就解决了大量的并发问题. 

#### 为什么Nginx不使用多线程
- Apache
    * 创建多个进程或线程, 而每个进程或线程都会为其分配 cpu 和内存(线程要比进程小的多, 所以worker支持比perfork高的并发), 并发过大会耗光服务器资源. 
- Nginx
    * 采用单线程来异步非阻塞处理请求(管理员可以配置Nginx主进程的工作进程的数量)(epoll), 不会为每个请求分配cpu和内存资源, 节省了大量资源, 同时也减少了大量的CPU的上下文切换. 所以才使得Nginx支持更高的并发. 

#### nginx能做的事
- 反向代理
    * 服务器根据客户端的请求, 从其关系的一组或多组后端服务器(如Web服务器)上获取资源, 然后再将这些资源返回给客户端, 客户端只会得知反向代理的IP地址, 而不知道在代理服务器后面的服务器簇的存在, 简单来说就是服务器无法被外部网络进行访问, 必须通过代理
- 动静分离
    * 利用反向代理功能将所有动态资源的请求交给应用服务器, 而静态资源的请求(图片, js, css)等则由nginx返回到浏览器, 以此来减轻服务器压力
- 负载均衡
    * 当一台服务器短时间内被多个用户访问时, 有可能会因为压力过大而宕机, 这个时候我们就需要用到负载均衡. 建立服务器集群, 用户先访问中间调度服务器, 然后根据每个服务器的配置以及空闲情况来分配用户访问到哪台服务器上, 分担服务器压力, 让每个服务器的压力趋于平衡 一般情况下负载均衡搭配反向代理使用, 先访问代理服务器根据情况分配用户
- 简单实现
    * 准备两个nginx服务
    ![服务1](/img/20211025_2.png)
    ![服务2](/img/20211025_1.png)
    * 反向代理
        * 想实现的效果: 访问服务器80端口下的proxypass, 请求打到5001端口下的index5001.html
        * nginx.conf
            ```bash
                upstream proxypassTest.com {
                    server 127.0.0.1:5001;
                }

                location /proxypass/ {
                    proxy_pass http://proxypassTest.com/;
                    index index5001.html;
                }
            ```
        * 实现效果
        ![反向代理](/img/20211025_3.png)
    * 负载均衡
        * 轮询(默认):每个请求按时间顺序分配到不同的后端服务器, 如果服务器down掉, 能自动剔除
        * 加权轮询法:简单来说按照自己设定的几率将请求分配到服务器上, 主要用于服务器性能分布不均的情况
        * IP哈希法: 每个请求按访问ip的hash结果分配, 可以将每个用户固定到一台服务器上
        * fair:按后端服务器的响应时间来分配请求, 响应时间快的优先分配
        * URL哈希: 按访问URL哈希结果分配, 让每个URL分配到同一台服务器上, 适用于服务器缓存
    * 关于upstream的参数
        * down:当前server不参与负载
        * weight=2:负载权重为2
        * max_fails和fail_timeout: #服务器X秒内出现请求失败X次, nginx会认为这台服务器已经宕机, X秒内不会再次进行请求, 将请求转发到其他正常机器, 时间结束后再次请求
        * backup;#其他非backup宕机或者忙的时候,会请求这台机器(热备机)


