---
title: Redis_基础 (20)
date: 2021-10-28
tags: Redis
toc: true
---

### 复习之redis
    从头再看一遍redis

<!-- more -->

#### Redis主从

##### 主从复制概述
> Redis 提供了主从模式, 通过主从复制, 将数据冗余一份复制到其他 Redis 服务器. 前者称为主节点 (master), 后者称为从节点 (slave)；数据的复制是单向的, 只能由主节点到从节点. 默认情况下, 每台 Redis 服务器都是主节点；且一个主节点可以有多个从节点 (或没有从节点), 但一个从节点只能有一个主节点. 
- 主从复制是如何保证一致性的
    * 读写分离
    * 读操作: 主、从库都可以执行；
    * 写操作: 主库先执行, 之后将写操作同步到从库；
- 为什么要采用读写分离的方式
    * 我们可以假设主从库都可以执行写指令, 假如对同一份数据分别修改了多次, 每次修改发送到不同的主从实例上, 就导致是实例的副本数据不一致了. 加锁会影响性能, redis不会这么干
- 主从复制的作用
    * 故障恢复: 当主节点宕机, 其他节点依然可以提供服务；
    * 负载均衡: Master 节点提供写服务, Slave 节点提供读服务, 分担压力；
    * 高可用基石: 是哨兵和 cluster 实施的基础, 是高可用的基石. 

##### 搭建主从复制
- 开启主从复制的方式
    * 配置文件
        * 在从服务器的配置文件中加入 replicaof &lt;masterip> &lt;masterport>
    * 启动命令
        * redis-server 启动命令后面加入 --replicaof &lt;masterip> &lt;masterport>
    * 客户端命令
        * 启动多个 Redis 实例后, 直接通过客户端执行命令: replicaof &lt;masterip> &lt;masterport>, 则该 Redis 实例成为从节点. 

##### 主从复制原理
- 为什么选RDB进行复制
    * RDB 文件是二进制文件, 网络传输 RDB 和写入磁盘的 IO 效率都要比 AOF 高. 
    * 从库进行数据恢复的时候, RDB 的恢复效率也要高于 AOF. 
- 第一次主从库全量复制
    ![全量复制](/img/20211028_1.png)
    * 连接建立阶段(即准备阶段)
        * 从库会和主库建立连接, 从库执行 replicaof 并发送 psync 命令并告诉主库即将进行同步, 主库确认回复后, 主从库间就开始同步了
        * 从库执行 replicaof 并发送 psync 命令, 表示要执行数据同步, 主库收到命令后根据参数启动复制. 命令包含了主库的 runID 和 复制进度 offset 两个参数. runID: 每个 Redis 实例启动都会自动生成一个 唯一标识 ID, 第一次主从复制, 还不知道主库 runID, 参数设置为 「?」. offset: 第一次复制设置为 -1, 表示第一次复制, 记录复制进度偏移量. 主库收到 psync 命令后, 会用 FULLRESYNC 响应命令带上两个参数: 主库 runID 和主库目前的复制进度 offset, 返回给从库. 从库收到响应后, 会记录下这两个参数. FULLRESYNC 响应表示第一次复制采用的全量复制, 也就是说, 主库会把当前所有的数据都复制给从库
    * 主库同步数据到从库阶段
        * master 执行 bgsave命令生成 RDB 文件, 并将文件发送给从库, 同时主库为每一个 slave 开辟一块 replication buffer 缓冲区记录从生成 RDB 文件开始收到的所有写命令. 从库收到 RDB 文件后保存到磁盘, 并清空当前数据库的数据, 再加载 RDB 文件数据到内存中
    * 发送同步期间新写命令到从库阶段
        * 从节点加载 RDB 完成后, 主节点将 replication buffer 缓冲区的数据发送到从节点, Slave 接收并执行, 从节点同步至主节点相同的状态. 
- 主从正常运行期间的同步
    * 当主从库完成了全量复制, 它们之间就会一直维护一个网络连接, 主库会通过这个连接将后续陆续收到的命令操作再同步给从库, 这个过程也称为基于长连接的命令传播, 使用长连接的目的就是避免频繁建立连接导致的开销. 
- 主从库间网络断开重连同步
    * 每个从库会记录自己的 slave_repl_offset, 每个从库的复制进度也不一定相同. 在和主库重连进行恢复时, 从库会通过 psync 命令把自己记录的 slave_repl_offset发给主库, 主库会根据从库各自的复制进度, 来决定这个从库可以进行增量复制, 还是全量复制. 

##### 主从复制问题
- 数据过期问题
    * 为了主从节点的数据一致性, 从节点不会主动删除数据, Redis 3.2 开始, 通过从节点读取数据时, 先判断数据是否已过期. 如果过期则不返回客户端, 并且删除数据
- 单机内存大小限制
    * 如果 Redis 单机内存达到 10GB, 一个从节点的同步时间在几分钟的级别；如果从节点较多, 恢复的速度会更慢. 如果系统的读负载很高, 而这段时间从节点无法提供服务, 会对系统造成很大的压力. 如果数据量过大, 全量复制阶段主节点 fork + 保存 RDB 文件耗时过大, 从节点长时间接收不到数据触发超时, 主从节点的数据同步同样可能陷入全量复制->超时导致复制中断->重连->全量复制->超时导致复制中断……的循环. 此外, 主节点单机内存除了绝对量不能太大, 其占用主机内存的比例也不应过大: 最好只使用 50% - 65% 的内存, 留下 30%-45% 的内存用于执行 bgsave 命令和创建复制缓冲区等



