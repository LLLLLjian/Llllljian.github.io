---
title: Redis_基础 (21)
date: 2021-10-29
tags: Redis
toc: true
---

### 复习之redis
    从头再看一遍redis

<!-- more -->

#### Redis哨兵
> 主从出现问题时, 自动切换主库, 维护系统的可用性, 用到的就是redis哨兵

![Redis哨兵概述](/img/20211029_1.png)

##### 什么是哨兵
> 是Redis 的高可用性解决方案. 通过一个或多个Sentinel 实例组成的Sentinel 系统可以监视多个主服务器和下属的所有从服务器, 当主服务器进入下线状态时, 自动将主服务器下的从服务器升级为新的主服务器

##### 哨兵的主要任务
- 监控
    * 持续监控 master 、slave 是否处于预期工作状态
    * Sentinel每秒一次的频率向master和slave发送ping命令, 如果slave没有在规定时间响应, 那么这个从节点就会被标记成下线状态; 假如master没有返回, 那么哨兵就会认为主节点下线, 开始执行自动切换主节点的流程
    * ping命令的回复状态
        * 有效回复: 返回 +PONG、-LOADING、-MASTERDOWN 任何一种
        * 无效回复: 有效回复之外的回复, 或者指定时间内返回任何回复
    * 为了防止掌门假死, 设置了**主观下线**, **客观下线**
        * 主观下线: 哨兵利用 PING 命令观察主节点, 察觉不到回复就认为主观下线
        * 客观下线: 为了防止某个哨兵误判, 如果过半的哨兵都判断主观下线, 那么主节点就被认为客观下线
        * 主观下线与客观下线的区别: 简单来说, 主观下线是哨兵自己认为节点宕机, 而客观下线是不但哨兵自己认为节点宕机, 而且该哨兵与其他哨兵沟通后, 达到一定数量的哨兵都认为该哥们嗝屁了
    * 一定数量的含义
        * 由哨兵监控配置决定的
        ```bash
            # sentinel monitor <master-name> <master-host> <master-port> <quorum>
            # sentinel monitor: 代表监控
            # mymaster: 代表主节点的名称, 可以自定义
            # 192.168.11.128: 代表监控的主节点 ip, 6379 代表端口
            # 2: 法定数量, 代表只有两个或两个以上的哨兵认为主节点不可用的时候, 才会把 master 设置为客观下线状态, 然后进行 failover 操作
            # 举例如下: 
            sentinel monitor mymaster 127.0.0.1 6379 2
        ```
- 自动切换主库
    * 当 Master 运行故障, 哨兵启动自动故障恢复流程: 从 slave 中选择一台作为新 master
    * 筛选条件
        * 从库当前在线状态, 下线的直接丢弃；
        * 评估之前的网络连接状态 **down-after-milliseconds \* 10**: 如果从库总是和主库断连, 而且断连次数超出了一定的阈值(10 次), 我们就有理由相信, 这个从库的网络状况并不是太好, 就可以把这个从库筛掉了
    * 打分
        * slave 优先级, 通过 slave-priority 配置项, 给不同的从库设置不同优先级(后台有人没办法), 优先级高的直接晋级为新 master 掌门. 
        * slave_repl_offset与 master_repl_offset进度差距(谁的武功与之前掌门的功夫越接近谁就更牛逼), 如果都一样, 那就继续下一个规则. 其实就是比较 slave 与旧 master 复制进度的差距；
        * slave runID, 在优先级和复制进度都相同的情况下, ID 号最小的从库得分最高, 会被选为新主库. (论资排辈, 根据 runID 的创建时间来判断, 时间早的上位)
- 通知
    * 让 slave 执行 replicaof , 与新的 master 同步；并且通知客户端与新 master 建立连接

##### 哨兵集群的工作原理
> 哨兵之间可以相互通信, 主要归功于Redis的 pub/sub 发布/订阅机制
- 哨兵间是如何知道彼此的
    * master 有一个 \__sentinel__:hello 的专用通道, 用于哨兵之间发布和订阅消息. 这就好比是 \__sentinel__:hello 微信群, 哨兵利用 master 建立的微信群发布自己的消息, 同时关注其他哨兵发布的消息
    * 当多个哨兵实例都在主库上做了发布和订阅操作后, 它们之间就能知道彼此的 IP 地址和端口, 从而相互发现建立连接. 
- 哨兵是如何知道slave并监控他们的
    * 哨兵向 master 发送 INFO 命令,  master 掌门自然是知道自己门下所有的 salve 小弟的. 所以 master 接收到命令后, 便将 slave 列表告诉哨兵. 
    * 哨兵根据 master 响应的 slave 名单信息与每一个 salve 建立连接, 并且根据这个连接持续监控哨兵. 
- 如何选择哨兵执行主从切换
    * 哨兵1发现主节点主管下线之后会和其它哨兵进行通信, 一旦获得 quorum 票之后就认为主节点客观下线, 这时候哨兵就会向其他哨兵发送消息, 声明自己要更换主节点, 并让其他人进行投票, 一旦投票过半并且赞成票大于quorum 那么就会更换主节点, 这也是哨兵集群布置成单数的原因, 双数的话会浪费
- 告诉所有人换主节点了
    * 通过 pub/sub 机制发布不同事件
    * master 下线事件
        * +sdown: 进入“主观下线”状态；
        * -sdown: 退出“主观下线”状态；
        * +odown: 进入“客观下线”状态；
        * -odown: 退出“客观下线”状态；
    * slave 重新配置事件
        * +slave-reconf-sent: 哨兵发送 replicaof 命令重新配置从库；
        * +slave-reconf-inprog: slave 配置了新 master, 但是尚未进行同步；
        * +slave-reconf-done: slave 配置了新 master, 并与新 master 完成了数据同步；
    * 新主库切换
        * +switch-master: master 地址发生了变化. 

##### 注意事项和关键配置
- down-after-milliseconds
    * Sentinel 配置文件中的 down-after-milliseconds 选项指定了 Sentinel 判断实例进入主观下线所需的时间长度: 如果一个实例在 down-after-milliseconds 毫秒内, 连续向 Sentinel 返回无效回复, 那么 Sentinel 会修改这个实例所对应数据, 以此来表示这个实例已经进入主观下线状态. 
    * 要保证所有哨兵实例的配置是一致的, 尤其是主观下线的判断值 down-after-milliseconds. 因为这个值在不同的哨兵实例上配置不一致, 导致哨兵集群一直没有对有故障的主库形成共识, 也就没有及时切换主库, 最终的结果就是集群服务不稳定. 
- down-after-milliseconds * 10
    * down-after-milliseconds 是我们认定主从库断连的最大连接超时时间. 如果在 down-after-milliseconds 毫秒内, 主从节点都没有通过网络联系上, 我们就可以认为主从节点断连了. 如果发生断连的次数超过了 10 次, 就说明这个从库的网络状况不好, 不适合作为新主库

##### 总结
- 哨兵主要任务
    * Redis 哨兵机制是实现 Redis 不间断服务的高可用手段之一. 主从架构集群的数据同步, 是数据可靠的基础保障；主库宕机, 自动执行主从切换是服务不间断的关键支撑. 
    * Redis 哨兵机制实现了主从库的自动切换, 再也不怕跟女盆友么么哒的时候 master 宕机了
        * 监控 master 与 slave 运行状态, 判断是否客观下线；
        * master 客观下线后, 选择一个 slave 切换成 master；
        * 通知 slave 和客户端新 master 信息. 
- 哨兵集群原理
    * 为了避免单个哨兵故障后无法进行主从切换, 以及为了减少误判率, 又引入了哨兵集群；哨兵集群又需要有一些机制来支撑它的正常运行: 
        * 基于 pub/sub 机制实现哨兵集群之间的通信；
        * 基于 INFO 命令获取 slave 列表, 帮助 哨兵与 slave 建立连接；
        * 通过哨兵的 pub/sub, 实现了与客户端和哨兵之间的事件通知. 
    * 主从切换, 并不是随意选择一个哨兵就可以执行, 而是通过投票仲裁, 选择一个 Leader, 由这个 Leader 负责主从切换. 



